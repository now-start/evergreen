# Evergreen v5 운영전략 구현 PRD

## 1. 문서 목적
본 문서는 `backtest_strategy_hyperparameter_decision_paper.md`의 결론을 기반으로, `v5` 전략을 실제 운영 가능한 시스템으로 구현하기 위한 제품 요구사항(Product Requirements)을 정의한다.

## 2. 배경 및 근거
- 연구 결론:
  - 운영 기본안: `v5` (Adaptive ATR Exit)
  - 병행 관찰안: `v4` (Weekly Filter)
- 선택 이유:
  - walk-forward 기준 위험/수익 균형 우수
  - `v3` 대비 과도한 회전율 리스크 낮음
  - 단일 hold-out 편향보다 다구간 검증에서 안정적

## 3. 목표
### 3.1 비즈니스 목표
- 실거래 적용 가능한 일봉 전략 파이프라인 구축
- 백테스트-시뮬레이션-실운영 간 로직 일치성 확보
- 운영 리스크(급격한 DD, 과도 거래) 모니터링 체계 확보

### 3.2 제품 목표
- `v5` 신호 엔진을 배치/리얼타임 실행 가능한 모듈로 제공
- 파라미터 버전 관리 및 실험 재현성 확보
- 결과 조회 API/리포트 산출 자동화

## 4. 범위
### 4.1 In-Scope
- `v5` 전략 엔진 구현
  - regime 전환 + adaptive ATR exit
  - volatility state 계산 및 multiplier 동적 적용
- 데이터 파이프라인
  - 일봉 OHLCV 수집/정제/저장
  - 결측/중복 처리, UTC 기준 정렬
- 실행 파이프라인
  - 일일 배치 신호 계산
  - 주문 의사결정 산출(진입/청산/유지)
- 검증 파이프라인
  - hold-out + walk-forward 자동 실행
  - 표준 리포트(JSON/CSV/이미지)
- 관찰 전략(`v4`) shadow 실행
  - 동일 데이터로 병행 계산
  - 성능 비교 대시보드 노출

### 4.2 Out-of-Scope (1차)
- 초단타/분봉 전략
- 다자산 포트폴리오 최적화
- 자동 실주문 체결(브로커 API 직접 송신)까지의 완전 자동화

## 5. 사용자 및 이해관계자
- 퀀트/전략 개발자: 파라미터 튜닝, 검증 해석
- 운영 담당자: 일일 신호 확인, 리스크 모니터링
- 엔지니어: 파이프라인 운영/장애 대응

## 6. 사용자 시나리오
1. 운영자는 매일 09:00 UTC에 생성된 `v5` 신호 리포트를 확인한다.
2. 운영자는 현재 포지션/목표 익스포저/청산 사유(레짐 반전, trail stop)를 확인한다.
3. 퀀트는 주간 단위로 `v5` vs `v4(shadow)` 성능 비교를 확인한다.
4. 이슈 발생 시 특정 날짜의 입력 데이터와 파라미터 버전으로 재현 실행한다.

## 7. 기능 요구사항
### 7.1 전략 엔진
- FR-1: `v5` 파라미터 입력을 받아 일봉 기준 신호를 계산해야 한다.
- FR-2: 변동성 상태(`high/low`)에 따라 ATR multiplier를 동적으로 적용해야 한다.
- FR-3: 각 바(row)에 최소 다음 정보를 포함해야 한다.
  - regime, regime bands, ATR stop, applied multiplier
  - signal(buy/sell/setup/trail_hit), position exposure, turnover
- FR-4: 거래비용은 turnover 비례로 반영해야 한다.

### 7.2 데이터/저장
- FR-5: 입력 데이터는 시간순 정렬 및 중복 제거되어야 한다.
- FR-6: 실행 결과(summary + rows)는 버전/파라미터 hash와 함께 저장되어야 한다.
- FR-6-1: 업비트 잔액/주문/체결 데이터는 run_id 및 signal_id와 연결 저장되어야 한다.

### 7.3 리포트/비교
- FR-7: 일일 리포트에 `CAGR/MDD/Final/BH/Trades`를 포함해야 한다.
- FR-8: walk-forward 결과를 split 단위 표로 제공해야 한다.
- FR-9: `v4` shadow 결과와 비교 컬럼을 제공해야 한다.

### 7.4 실행(잔액/주문)
- FR-10: 신호 실행 전 잔액 조회를 수행해야 한다.
- FR-11: 주문 가능 정보(`orders/chance`) 기반으로 주문 파라미터를 검증해야 한다.
- FR-12: 실주문 생성/조회/취소 API를 표준 실행기로 감싸야 한다.
- FR-13: `PAPER/LIVE` 모드 분리 및 LIVE 이중 안전장치를 제공해야 한다.

### 7.5 운영 안전장치
- FR-14: 파라미터 유효성 검증 실패 시 실행 중단 및 알림
- FR-15: 데이터 품질 임계치 미달 시 신호 생성 차단(fail-safe)

## 8. 비기능 요구사항
- NFR-1: 동일 입력/파라미터 재실행 시 결과 결정적 동일성
- NFR-2: 일일 배치 완료 시간 5분 이내(단일 자산 기준)
- NFR-3: 모든 실행 로그에 run_id, config_version 포함
- NFR-4: 장애 시 재시도/재실행 가능(멱등성 보장)

## 9. 성공 지표 (KPI)
- 전략 품질:
  - 3개월 이동 창에서 MDD 임계치 이하 유지
  - walk-forward mean calmar 최소 기준 달성
- 운영 품질:
  - 배치 성공률 99%+
  - 데이터 품질 오류 탐지율 100%
- 재현성:
  - 임의 run 재현 성공률 100%

## 10. 릴리즈 계획
### Phase 1: 엔진 정합화
- Python 연구 엔진(`v5.py`)과 운영 엔진 로직 1:1 정합
- 단위/통합 테스트 구축

### Phase 2: 배치/저장/리포트
- 일일 실행 스케줄러 연결
- 결과 저장 스키마/리포트 API 제공

### Phase 3: Shadow 운영
- `v4` shadow 병행
- 4주 이상 비교 모니터링 후 운영전략 확정

## 11. 리스크 및 대응
- 리스크: 특정 구간 과최적화
  - 대응: walk-forward 지속 모니터링, 분기별 재튜닝
- 리스크: 거래비용 과소추정
  - 대응: 비용 민감도 시나리오(기본/보수/스트레스)
- 리스크: 데이터 소스 장애
  - 대응: 캐시 fallback, 결측일 경고 및 신호 차단

## 12. 승인 기준
- AC-1: 백테스트/리서치 대비 결과 편차 허용범위 내
- AC-2: 운영 리포트 자동 생성 및 검증 통과
- AC-3: 장애 복구 시나리오 리허설 완료

## 13. 연동 정의서
- Upbit 연동 계약/장애대응/캐시 규격은 아래 문서를 따른다.
  - `docs/upbit_integration_spec.md`
