# 백테스트 비교를 통한 전략 및 하이퍼파라미터 의사결정 연구

## 초록
본 연구는 `@backtest`의 최종 전략/하이퍼파라미터 결정 근거를 정량적으로 제시한다. 분석 대상은 두 전략 계열이다: (S1) RSI+MA 기반 추세 전략, (S2) Regime(EMA band)+ATR trailing stop 전략. 2026-02-20 기준 반복 실행 및 동일 기간 통제 실험을 통해 `CAGR`, `MDD`, `Calmar-like`, `Final/BH`, 거래횟수를 비교했다. 결과적으로 S1은 수익률 지표에서 우세한 구간이 있었고, S2는 거래 횟수 절감과 장기 구간의 낙폭 제어에서 운영 안정성을 보였다. 본 프로젝트는 운영 목적(리스크/복잡도 관리)을 우선해 S2(`regimeEmaLen=100`, `atrPeriod=14`, `atrTrailMultiplier=3.0`, `regimeBand=0.01`)를 최종 채택한다.

## 핵심어
백테스트, 전략 비교, CAGR, MDD, Calmar-like, 하이퍼파라미터, KRW-BTC

## 1. 서론
전략 채택은 단일 수익률 극대화 문제가 아니라, 손실 통제·거래비용·재현성·운영 복잡도를 함께 고려하는 다기준 의사결정 문제다. 본 문서는 이전/현재 전략을 동일 프레임에서 비교하고, 최종 채택 결론을 수치 기반으로 제시한다.

## 2. 방법
### 2.1 데이터와 비용 가정
- 자산: `KRW-BTC` 일봉
- 거래비용: `feePerSide=0.0005`, `slippage=0.0002`
- 분할: `validation-ratio=0.7`
- 평가지표: `Final Equity`, `Buy&Hold Equity`, `CAGR`, `MDD`, `Trades`

### 2.2 비교 전략
| 구분 | S1 (초기형) | S2 (운영형) |
|---|---|---|
| 핵심 구조 | MA 추세 + RSI 필터 | EMA 레짐 전환 + ATR 추적손절 |
| 진입 조건 | `close > MA`, MA 기울기 양(+), `RSI < rsiBuy` | BEAR→BULL 전환 시 3유닛 진입 |
| 청산 조건 | `close < MA` | BULL→BEAR 전환 또는 ATR trail stop |
| 포지션 | 0/1 (단일) | 0~3 유닛 (목표 3유닛) |
| 주요 파라미터 | `rsiBuy`, `maLen`, `maSlopeDays` | `regimeEmaLen`, `atrPeriod`, `atrTrailMultiplier`, `regimeBand` |

### 2.3 선택 규칙
후보 정렬 기준:
1. `calmarLike = CAGR / |MDD|`
2. `CAGR`
3. `finalEquity`

### 2.4 실험 설계
1. 실험 A (기본 설정 비교): 각 전략의 기본 설정 그대로 실행.
2. 실험 B (동일 기간 통제): 전략 간 공정 비교를 위해 동일 기간으로 교차 실행.
- P2020: 2020-01-01 ~ 2026-02-20 (VALID 1570, TEST 673)
- P2017: 2017-09-25 ~ 2026-02-20 (VALID 2149, TEST 922)

## 3. 결과
### 3.1 현재 운영 전략 결과(S2)
- 최종 파라미터: `regimeEmaLen=100`, `atrPeriod=14`, `atrTrailMultiplier=3.0`, `regimeBand=0.01`
- VALID: `final=10.2210`, `bh=9.0932`, `CAGR=48.48%`, `MDD=-37.86%`, `trades=44`
- TEST: `final=1.5568`, `bh=2.5142`, `CAGR=19.19%`, `MDD=-19.08%`, `trades=14`

### 3.2 실험 A: 기본 설정 비교
| 설정 | 전략 | 기간(VALID/TEST) | Grid | 선택 파라미터(요약) | VALID | TEST |
|---|---|---|---:|---|---|---|
| A1 | S1 | 2020-01-01~2024-04-18 / 2024-04-19~2026-02-20 | 172,800 | `rsiBuy=75, maLen=30, maSlopeDays=1` | `CAGR=120.45%, MDD=-28.99%, final=29.8364` | `CAGR=29.32%, MDD=-11.80%, final=1.6050` |
| A2 | S2 | 2017-09-25~2023-08-13 / 2023-08-14~2026-02-20 | 1 | `emaLen=100, atr=14, mult=3.0, band=0.01` | `CAGR=48.48%, MDD=-37.86%, final=10.2210` | `CAGR=19.19%, MDD=-19.08%, final=1.5568` |

### 3.3 실험 B: 동일 기간 통제 비교
#### 3.3.1 P2020 비교 (2020-01-01~2026-02-20)
| 지표 | S1 | S2 |
|---|---:|---:|
| VALID CAGR | 120.45% | 62.61% |
| VALID MDD | -28.99% | -28.43% |
| TEST CAGR | 29.32% | 27.47% |
| TEST MDD | -11.80% | -19.08% |
| TEST Final | 1.6050 | 1.5628 |
| TEST BH | 1.0577 | 1.0577 |
| TEST Calmar-like (`CAGR/|MDD|`) | 2.48 | 1.44 |
| TEST Trades | 36 | 10 |

#### 3.3.2 P2017 비교 (2017-09-25~2026-02-20)
| 지표 | S1 | S2 |
|---|---:|---:|
| VALID CAGR | 86.48% | 48.48% |
| VALID MDD | -32.56% | -37.86% |
| TEST CAGR | 54.92% | 19.19% |
| TEST MDD | -25.76% | -19.08% |
| TEST Final | 3.0155 | 1.5568 |
| TEST BH | 2.5142 | 2.5142 |
| TEST Calmar-like (`CAGR/|MDD|`) | 2.13 | 1.01 |
| TEST Trades | 42 | 14 |

### 3.4 지표별 비교분석
#### 3.4.1 수익성(CAGR/Final)
- P2020 TEST: S1이 S2 대비 `CAGR +1.85%p`, `Final +0.0421`.
- P2017 TEST: S1이 S2 대비 `CAGR +35.73%p`, `Final +1.4588`.

#### 3.4.2 위험(MDD)
- P2020 TEST: S1 낙폭 우위(`-11.80%` vs `-19.08%`).
- P2017 TEST: S2 낙폭 우위(`-19.08%` vs `-25.76%`, `6.68%p` 개선).

#### 3.4.3 운용 복잡도(거래횟수)
- S2 TEST 거래횟수: P2020 `36→10(-72.2%)`, P2017 `42→14(-66.7%)`.
- 비용 민감도 및 실운영 관리 부담 측면에서 S2 우위.

#### 3.4.4 일반화 갭(Valid-Test CAGR)
- 정의: `Gap = Valid CAGR - Test CAGR`
- P2020: S1 `91.13%p`, S2 `35.14%p`
- P2017: S1 `31.56%p`, S2 `29.29%p`
- S2가 전반적으로 갭이 작거나 유사해, 과최적화 민감도가 상대적으로 낮다.

## 4. 최종 의사결정
### 4.1 의사결정 원칙
1. 외부표본(TEST)에서 안정적 양(+) 수익성
2. 낙폭 관리 가능성
3. 거래횟수 및 운영 복잡도
4. 반복 실행 재현성

### 4.2 결론
- 운영 기준 전략은 S2(`regimeEmaLen=100`, `atrPeriod=14`, `atrTrailMultiplier=3.0`, `regimeBand=0.01`)로 확정한다.
- 근거는 (a) 장기 구간 테스트 낙폭 관리, (b) 거래횟수의 구조적 절감, (c) 반복 실행 재현성이다.
- 수익률 극대화 관점에서 S1 우위 구간이 존재하므로, S1은 보조(고수익/고변동) 슬롯으로 병행 모니터링 가능하다.

## 5. 타당도 위협 및 한계
1. 기본 설정 비교는 기간 자체가 상이하므로 직접 우열 단정이 어렵다.
2. 통제 실험은 2개 기간(P2020, P2017)에 한정되어 롤링 윈도우 추가 검증이 필요하다.
3. 단일 자산(`KRW-BTC`) 중심 결과이므로 자산군 확장 검증이 필요하다.
4. 거래비용 모델이 고정값이므로, 유동성 시나리오 기반 민감도 분석이 필요하다.

## 6. 재현 정보
### 6.1 현재 설정 실행
```bash
./gradlew -q backtestRun
```

### 6.2 기간 통제 실행 예시
```bash
# P2017 기간 실행
./gradlew -q backtestRun --args='--backtest.from-dt=1000-01-01T00:00:00Z --backtest.to-dt=2030-01-01T00:00:00Z'

# P2020 기간 실행
./gradlew -q backtestRun --args='--backtest.from-dt=2020-01-01T00:00:00Z --backtest.to-dt=2027-01-01T00:00:00Z'
```

## 부록 A. 로그 아티팩트
- 최신 실행 로그: `outputs/backtest_run_20260220.log`
- 전략 비교 로그:
  - `outputs/strategy-comparison/s1_base_p2020.log`
  - `outputs/strategy-comparison/s2_base_p2017.log`
  - `outputs/strategy-comparison/s1_control_p2017.log`
  - `outputs/strategy-comparison/s2_control_p2020.log`

## 부록 B. 상세 비교분석 자료
### B.1 기간별 우위 요약 (TEST 기준)
| 기간 | 수익성 우위 | 위험(MDD) 우위 | 거래횟수 우위 | 해석 |
|---|---|---|---|---|
| P2020 | S1 (`CAGR +1.85%p`) | S1 (`|MDD| -7.28%p`) | S2 (`-72.2%`) | S1 성과 우세, S2 저회전 |
| P2017 | S1 (`CAGR +35.73%p`) | S2 (`|MDD| -6.68%p`) | S2 (`-66.7%`) | 수익-위험 절충 구조 |

### B.2 상대성과(BH 대비) 비교
| 기간 | 전략 | TEST Final/BH | 해석 |
|---|---|---:|---|
| P2020 | S1 | 1.517 | BH 대비 +51.7% |
| P2020 | S2 | 1.478 | BH 대비 +47.8% |
| P2017 | S1 | 1.199 | BH 대비 +19.9% |
| P2017 | S2 | 0.619 | BH 대비 -38.1% |

### B.3 안정성(일반화 갭) 비교
| 기간 | 전략 | Valid CAGR | Test CAGR | Gap (pp) |
|---|---|---:|---:|---:|
| P2020 | S1 | 120.45% | 29.32% | 91.13 |
| P2020 | S2 | 62.61% | 27.47% | 35.14 |
| P2017 | S1 | 86.48% | 54.92% | 31.56 |
| P2017 | S2 | 48.48% | 19.19% | 29.29 |

### B.4 부록 B 결론
- S1은 높은 CAGR 중심의 성장형 특성이 강하다.
- S2는 저회전과 낙폭 통제 중심의 운영형 특성이 강하다.
- 운영 목적(리스크/복잡도 관리 우선)에 따라 S2를 기본 전략으로 채택한다.
